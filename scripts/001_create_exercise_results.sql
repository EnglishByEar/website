-- 001_create_exercise_results.sql
-- Creates the table used by /dashboard and the exercise page
-- Safe to re-run: it checks for existence before creating anything.

-- 1.  TABLE -----------------------------------------------------------------
create table if not exists public.exercise_results (
  id            bigint generated by default as identity primary key,
  user_id       uuid        not null references auth.users(id) on delete cascade,
  exercise_id   integer     not null,
  user_text     text,
  accuracy      integer     not null check (accuracy between 0 and 100),
  mistakes      integer     not null,
  completed_at  timestamptz not null default now()
);

comment on table  public.exercise_results is 'Listening-exercise submissions';
comment on column public.exercise_results.user_text is 'The raw text the learner typed';
comment on column public.exercise_results.accuracy  is 'Percentage accuracy (0â€“100)';

-- 2.  RLS POLICY ------------------------------------------------------------
alter table public.exercise_results enable row level security;

-- Allow the logged-in user to insert rows for themselves
create policy "Users can insert their own results"
  on public.exercise_results
  for insert
  with check (auth.uid() = user_id);

-- Allow the owner to read their own rows
create policy "Users can select their own results"
  on public.exercise_results
  for select
  using (auth.uid() = user_id);
